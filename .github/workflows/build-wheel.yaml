name: build-and-upload-release

on:
  release:
    types: [published]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python: [cpython-3.12, cpython-3.13]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        #with:
        #enable-cache: true

      - name: Install Python with uv
        run: uv python install ${{ matrix.python }}

      - name: Create venv
        run: uv venv

      - name: Install project dependencies with uv
        run: uv sync

      - name: Build distribution
        run: uv build

      - name: Upload built artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-${{ matrix.os }}-${{ matrix.python }}
          path: dist/*

  upload:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Upload artifacts to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          UPLOAD_URL: ${{ github.event.release.upload_url }}
        run: |
          set -euo pipefail
          upload_url="${UPLOAD_URL%\{*}"
          echo "Uploading artifacts to $upload_url"
          shopt -s globstar || true
          for f in artifacts/**; do
            if [ -f "$f" ]; then
              echo "Uploading $f"
              curl -sS -X POST \
                -H "Authorization: token $GITHUB_TOKEN" \
                -H "Content-Type: application/octet-stream" \
                --data-binary @"$f" \
                "$upload_url?name=$(basename "$f")"
            fi
          done
